<!DOCTYPE html>
<html>
<head>
<meta name="theme-color" content="#DC603A">
<meta property="og:title" content="HPaste">
<meta property="og:description" content="/* eslint-disable no-lonely-if */...">
<link rel="stylesheet" href="atom-one-dark.css">
<link rel="stylesheet" href="paste.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.min.js"></script>
</head>
<body>
<pre><code id="code">/* eslint-disable no-lonely-if */
const formidable = require(&#39;formidable&#39;);
const fs = require(&#39;fs-extra&#39;);
const { Remarkable } = require(&#39;remarkable&#39;);
const ejs = require(&#39;ejs&#39;);
const exif = require(&#39;exif2&#39;);

const md = new Remarkable(&#39;full&#39;, {
    html: false,
    linkify: true,
    typographer: true,
});
async function files(req, res) {
    res.setHeader(&#39;Content-Type&#39;, &#39;text/text&#39;);
    const fileName = this.randomToken(this.c.fileNameLength, false);
    const form = new formidable.IncomingForm();
    const protocol = this.protocol();
    // eslint-disable-next-line no-shadow
    form.parse(req, (err, fields, files) =&gt; {
        let userIP = req.headers[&#39;x-forwarded-for&#39;] || req.connection.remoteAddress || req.socket.remoteAddress || req.connection.socket.remoteAddress.split(&#34;,&#34;)[0]; userIP = userIP.split(&#34;,&#34;)[0];
        const authKey = fields.key;
        let usingUploader = false;
        if (files.fdataUploader &amp;&amp; !fields.key) {
            usingUploader = true;
            // eslint-disable-next-line no-param-reassign
            files.fdata = files.fdataUploader;
        }
        if (files.file) {
            files.fdata = files.file;
        }
        if (!this.auth(this.c.key, fields.key, this.c) &amp;&amp; usingUploader === false) {
            res.statusCode = 401;
            res.write(&#39;Unauthorized&#39;);
            res.end();
            return this.log.warning(`Unauthorized User | File Upload | ${userIP} | ${authKey}`);
        } if (!this.auth(this.c.key, fields.password, this.c) &amp;&amp; usingUploader === true) {
            this.log.warning(this.auth(this.c.key, fields.password, this.c));
            res.statusCode = 401;
            res.redirect(&#39;/?error=Incorrect_Password&#39;);
            res.end();
            return this.log.warning(`Unauthorized User | File Upload | ${userIP} | ${authKey}`);
        }
        const oldpath = files.fdata.path;
        const fileExt = files.fdata.name.substring(files.fdata.name.lastIndexOf(&#39;.&#39;) + 1, files.fdata.name.length).toLowerCase();
        let newpath;
        if(this.c.dateURLPath === true) {
            let currentMonth = getDate(&#39;month&#39;)
            let currentYear = getDate(&#39;year&#39;)
            let currentDay = getDate(&#39;day&#39;)
            let baseDir = `${__dirname}/../uploads/`
            let basePWDir = `${__dirname}/../passwordUploads/`
            fs.access(`${baseDir}${currentYear}/${currentMonth}/${currentDay}`, err =&gt; {
                if (err &amp;&amp; err.code === &#39;ENOENT&#39;) {
                    fs.mkdirSync(`${baseDir}${currentYear}`);
                    fs.mkdirSync(`${baseDir}${currentYear}/${currentMonth}`);
                    fs.mkdirSync(`${baseDir}${currentYear}/${currentMonth}/${currentDay}`)
                }
            });
            fs.access(`${basePWDir}${currentYear}/${currentMonth}/${currentDay}`, err =&gt; {
                if (err &amp;&amp; err.code === &#39;ENOENT&#39;) {
                    fs.mkdirSync(`${basePWDir}${currentYear}`);
                    fs.mkdirSync(`${basePWDir}${currentYear}/${currentMonth}`);
                    fs.mkdirSync(`${basePWDir}${currentYear}/${currentMonth}/${currentDay}`)
                }
            });
        }
        fields.pupload
            ? newpath = `${__dirname}/../passwordUploads/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${fileName}.${fileExt}`
            : newpath = `${__dirname}/../uploads/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${fileName}.${fileExt}`;
        let returnedFileName;
        if (!fileExt.includes(&#39;png&#39;) &amp;&amp; !fileExt.includes(&#39;jpg&#39;) &amp;&amp; !fileExt.includes(&#39;jpeg&#39;) &amp;&amp; !fileExt.includes(&#39;md&#39;) &amp;&amp; !fields.pupload) {
            returnedFileName = `${fileName}.${fileExt}`;
        } else {
            returnedFileName = fileName;
        }
        if(fields.showCase) {
            fields.showCase = true
        }
        let showCaseFile;
        if(fields.showCase !== false) {
            showCaseFile = this.randomToken(this.c.fileNameLength, false);
        }
        this.db.get(&#39;files&#39;)
            .push({
                path: fields.showCase ? `/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${showCaseFile}` : `/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName}`,
                ip: userIP,
                views: 0,
                original: newpath,
                showCase: fields.showCase ? true : false
            })
            .write();
        let settings;
        let isAdmin = false;
        if (!this.c.admin.key.includes(fields.key)) {
            settings = this.c;
        } else {
            settings = this.c.admin;
            isAdmin = true;
        }
        if (Math.round((files.fdata.size / 1024) / 1000) &gt; settings.maxUploadSize &amp;&amp; !isAdmin) {
            if (this.monitorChannel !== null) this.bot.createMessage(this.monitorChannel, `\`\`\`MARKDOWN\n[FAILED UPLOAD][USER]\n[FILE](${files.fdata.name})\n[SIZE](${Math.round(files.fdata.size / 1024)}KB)\n[TYPE](${files.fdata.type})\n[KEY](${authKey})\n[IP](${userIP})\n\n[ERROR](ERR_FILE_TOO_BIG)\`\`\``);
            res.statusCode = 413;
            if (usingUploader === true) {
                res.redirect(&#39;/?error=File_Too_Big&#39;);
                return res.end();
            }
            res.write(`${protocol}://${req.headers.host}/ERR_FILE_TOO_BIG`);
            return res.end();
        }
        if (!settings.allowed.some(ext =&gt; fileExt.endsWith(ext)) &amp;&amp; !settings.allowed.includes(&#34;*&#34;)) {
            if (this.monitorChannel !== null) this.bot.createMessage(this.monitorChannel, `\`\`\`MARKDOWN\n[FAILED UPLOAD][USER]\n[FILE](${files.fdata.name})\n[SIZE](${Math.round(files.fdata.size / 1024)}KB)\n[TYPE](${files.fdata.type})\n[KEY](${authKey})\n[IP](${userIP})\n\n[ERROR](ERR_ILLEGAL_FILE_TYPE)\`\`\``); 
            res.statusCode = 415;
            if (usingUploader === true) {
                res.redirect(&#39;/?error=Illegal_File_Type&#39;);
                return res.end();
            }
            res.write(`${protocol}://${req.headers.host}/ERR_ILLEGAL_FILE_TYPE`);
            return res.end();
        }
        if (fields.pupload) {
            let altKey = this.randomToken(this.c.puploadKeyGenLength, true);
            fs.move(oldpath, newpath, () =&gt; {
                let puploadKey
                if(fields.pupload === &#39;*random*&#39;) {
                    puploadKey = altKey;
                } else {
                    puploadKey = fields.pupload;
                }
                this.db.get(&#39;passwordUploads&#39;)
                    .push({
                        fileName: `${fileName}.${fileExt}`,
                        key: puploadKey,
                    })
                    .write();
                fs.readFile(newpath, &#39;utf-8&#39;, () =&gt; {
                    const stream = fs.createWriteStream(`${__dirname}/../uploads/${fileName}.html`);
                    stream.once(&#39;open&#39;, () =&gt; {
                        ejs.renderFile(`${__dirname}/../views/puploadAuth.ejs`, {
                            fileName: `${fileName}.${fileExt}`,
                        }, {}, (_err, str) =&gt; {
                            stream.write(str);
                        });
                        stream.end();
                    });
                });
            });
            if (this.monitorChannel !== null) this.bot.createMessage(this.monitorChannel, `\`\`\`MARKDOWN\n[NEW UPLOAD][USER]\n[SIZE](${Math.round(files.fdata.size / 1024)}KB)\n[TYPE](${files.fdata.type})\n[KEY](${authKey})\n[IP](${userIP})\n\`\`\`\n${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName}`);
            if (err) return res.write(err);
            this.log.verbose(`New File Upload: ${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName} | IP: ${userIP} | KEY: ${authKey}`);
            if (usingUploader === true) {
                res.redirect(`/?success=${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName}`);
                return res.end();
            }
            fields.pupload === &#39;*random*&#39; ? res.write(`URL: ${protocol}://${req.headers.host}/${returnedFileName} | KEY: ${altKey}`) : res.write(`${protocol}://${req.headers.host}/${returnedFileName}`);
            return res.end();
        }
        if (fields.showCase === true) {
            if(fileExt === &#34;png&#34; || fileExt === &#34;jpg&#34; || fileExt === &#34;gif&#34; || fileExt === &#34;jpeg&#34;) {
                returnedFileName = `${showCaseFile}.html`
                fs.move(oldpath, newpath, () =&gt; {
                    fs.readFile(newpath, &#39;utf-8&#39;, (err, data) =&gt; {
                        exif(newpath, (err, obj) =&gt; {
                            if(!obj[&#39;camera model name&#39;]) obj[&#39;camera model name&#39;] = &#34;N/A&#34;;
                            if(!obj[&#39;f number&#39;]) obj[&#39;f number&#39;] = &#34;N/A&#34;;
                            if(!obj[&#39;exposure time&#39;]) obj[&#39;exposure time&#39;] = &#34;N/A&#34;;
                            if(!obj[&#39;iso&#39;]) obj[&#39;iso&#39;] = &#34;N/A&#34;;
                            if(!obj[&#39;focal length&#39;]) obj[&#39;focal length&#39;] = &#34;N/A&#34;;
                            if(!obj[&#39;image size&#39;]) obj[&#39;image size&#39;] = &#34;N/A&#34;;
                            if(!obj[&#39;lens id&#39;]) obj[&#39;lens id&#39;] = &#34;N/A&#34;;
                            let camera = obj[&#39;camera model name&#39;].replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let fstop = `f/${obj[&#39;f number&#39;]}`.replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let shutter = obj[&#39;exposure time&#39;].replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let iso = obj[&#39;iso&#39;].replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let focal = obj[&#39;focal length&#39;].replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let dims = obj[&#39;image size&#39;].replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let lens = obj[&#39;lens id&#39;].replace(/&lt;|&gt;|&amp;lt;|&amp;gt;/gm, &#34;&#34;)
                            let width = parseInt(dims.split(&#39;x&#39;)[0]);
                            let height = parseInt(dims.split(&#39;x&#39;)[1]);
                            if(height &gt; 700) {
                                let magicNumber = height / 700;
                                height = height / magicNumber;
                                width = width / magicNumber
                            }
                            let sizing = [width, height]
                            const stream = fs.createWriteStream(`${__dirname}/../uploads/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${showCaseFile}.html`);
                            stream.once(&#39;open&#39;, () =&gt; {
                                ejs.renderFile(`${__dirname}/../views/photoShowCase.ejs`, {
                                    camera: camera,
                                    fstop, fstop,
                                    shutter, shutter,
                                    iso: iso,
                                    focal: focal,
                                    dims: dims,
                                    lens: lens,
                                    width: sizing[0],
                                    height: sizing[1],
                                    filename: `${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${fileName}.${fileExt}`
                                }, {}, (_err, str) =&gt; {
                                    stream.write(str);
                                });
                                stream.end();
                            });
                        });
                    });
                });
                if (this.monitorChannel !== null) this.bot.createMessage(this.monitorChannel, `\`\`\`MARKDOWN\n[NEW UPLOAD][USER]\n[SIZE](${Math.round(files.fdata.size / 1024)}KB)\n[TYPE](${files.fdata.type})\n[KEY](${authKey})\n[IP](${userIP})\n\`\`\`\n${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${showCaseFile}`);
                if (err) return res.write(err);
                this.log.verbose(`New File Upload: ${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${showCaseFile} | IP: ${userIP} | KEY ${authKey}`);
                if (usingUploader === true) {
                    res.redirect(`/?success=${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${showCaseFile}`);
                    return res.end();
                }
                res.write(`${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${showCaseFile}`);
                return res.end();
            }
        }
        fs.move(oldpath, newpath, () =&gt; {
            if (fileExt.toLowerCase() === &#39;md&#39; &amp;&amp; this.c.markdown) {
                fs.readFile(newpath, &#39;utf-8&#39;, (_readErr, data) =&gt; {
                    const stream = fs.createWriteStream(`${__dirname}/../uploads/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${fileName}.html`);
                    stream.once(&#39;open&#39;, () =&gt; {
                        ejs.renderFile(`${__dirname}/../views/md.ejs`, {
                            ogDesc: data.match(/.{1,297}/g)[0],
                            mdRender: md.render(data),
                        }, {}, (_renderErr, str) =&gt; {
                            stream.write(str);
                        });
                        stream.end();
                        fs.unlink(newpath, delErr =&gt; {
                            if (delErr) return this.log.warning(delErr);
                        });
                    });
                });
            }
            if (this.monitorChannel !== null) this.bot.createMessage(this.monitorChannel, `\`\`\`MARKDOWN\n[NEW UPLOAD][USER]\n[SIZE](${Math.round(files.fdata.size / 1024)}KB)\n[TYPE](${files.fdata.type})\n[IP](${userIP})\n[KEY](${authKey})\n\`\`\`\n${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName}`);
            if (err) return res.write(err);
            this.log.verbose(`New File Upload: ${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName} | IP: ${userIP} | KEY: ${authKey}`);
            if (usingUploader === true) {
                res.redirect(`/?success=${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName}`);
                return res.end();
            }
            res.write(`${protocol}://${req.headers.host}/${this.c.dateURLPath === true ? `${getDate(&#39;year&#39;)}/${getDate(&#39;month&#39;)}/${getDate(&#39;day&#39;)}/`: &#34;&#34;}${returnedFileName}`);
            return res.end();
        });
    });
}
//const currentMonth = date.getMonth() + 1;
function getDate(type) {
    if(type.toLowerCase() === &#39;year&#39;) {
        const date = new Date();
        const currentYear = date.getFullYear();
        return currentYear;
    }
    if(type.toLowerCase() === &#39;month&#39;) {
        const date = new Date();
        let currentMonth = `${date.getMonth() + 1}`;
        if(currentMonth.length === 1) currentMonth = `0${currentMonth}`
        return currentMonth;
    }
    if(type.toLowerCase() === &#39;day&#39;) {
        const date = new Date();
        let currentDay = `${date.getDate()}`;
        if(currentDay.length === 1) currentDay = `0${currentDay}`;
        return currentDay;
    }
}
module.exports = files;
</code></pre>
<script>hljs.initHighlightingOnLoad()</script>
<script>hljs.initLineNumbersOnLoad();</script>
</body>
</html>